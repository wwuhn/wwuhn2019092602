<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<base target="_blank" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title></title>
<script type="text/javascript">
var userAgent = navigator.userAgent.toLowerCase();
var browser = 
	(browser = userAgent.match(/qqbrowser\/([\d.]+)/))?"qqbrowser/"+browser[1]:
	(browser = userAgent.match(/se\s+2.x/))?"sogou/2.x": //sougou
	(browser = userAgent.match(/msie\s+([\d.]+)/))?"msie/"+browser[1]: //ie
	(browser = userAgent.match(/chrome\/([\d.]+)/))?"chrome/"+browser[1]: //chrome
	(browser = userAgent.match(/firefox\/([\d.]+)/))?"firefox/"+browser[1]: //firefox
	(browser = userAgent.match(/version\/([\d.]+)\s+safari\/([\d.]+)/))?"safari/"+browser[1]: //safari
	(browser = userAgent.match(/opera\/([\d.]+)([\w\W]+)version\/([\d.]+)/))?"opera/"+browser[3]: //opera
	"other browser";
	var browser4 = browser.substr(0,2);
//实现回到页面顶部  
function goTopEx(){  
	var obj=document.getElementById("goTopBtn"); 
	var obj2=document.getElementById("shangy"); 
	var obj3=document.getElementById("xiay");
	var obj4=document.getElementById("goBottom");  
	
	function getScrollTop(){  
		if(browser4=="ch"){
			//chrome
			//chrome63.0.3239.132对DTD XHTML 1.0不再支持body.scrollTop属性，只支持documentElement.scrollTop 
			return document.documentElement.scrollTop; 
		}else{
			//IE、firefox
			return document.documentElement.scrollTop;  
		}  
	}
	function setScrollTop(value){ 
		if(browser4=="ch"){ 
			//chrome
			document.documentElement.scrollTop=value; 
		}else{  
			//IE、firefox
			document.documentElement.scrollTop=value;  
		} 
	}     
	window.onscroll=function(){getScrollTop()>50?obj.style.display="":obj.style.display="none";
	getScrollTop()>100?obj2.style.display="":obj2.style.display="none";
	document.body.clientHeight-getScrollTop()>650?obj3.style.display="":obj3.style.display="none";
	document.body.clientHeight-getScrollTop()>650?obj4.style.display="":obj4.style.display="none";
	}  
	obj.onclick=function(){  
		var goTop=setInterval(scrollMove,10);  
		function scrollMove(){  
				setScrollTop(getScrollTop()/1.1);  
				if(getScrollTop()<1)clearInterval(goTop);  
		}  
	}  
}  
function downn(){
	if(browser4=="ch"){
		//chrome
		window.scrollBy(0,document.body.clientHeight);
	}else{
		//IE、firefox
		window.scrollBy(0,document.documentElement.clientHeight*1000); 
	}
}
</script>
<script>
function changePage(){ 
	var page = document.getElementById("container");
	page.style.background="black";
	page.style.color="white";
	page.style.fontSize="22px";
	page.style.fontFamily="MV boli";
}
document.write('<div style="position:fixed; right: 10px; top:20px; color:#eee;">背景颜色<br><select name=bcolor id=bcolor onchange="javascript:document.body.style.background=this.options[this.selectedIndex].value;"><option style="background-color: #ffffff" value="#ffffff">白色</option><option style="background-color: #f6f6f6" value="#f6f6f6">银灰</option><option style="background-color: #e4ebf1" value="#e4ebf1">淡蓝</option><option style="background-color: #e6f3ff" value="#e6f3ff">蓝色</option> <option style="background-color: #eeeeee" value="#eeeeee">淡灰</option><option style="background-color: #eaeaea" value="#eaeaea">灰色</option>  <option style="background-color: #e4e1d8" value="#e4e1d8">深灰</option><option style="background-color: #e6e6e6" value="#e6e6e6">暗灰</option><option style="background-color: #eefaee" value="#eefaee">绿色</option><option style="background-color: #ffffed" value="#ffffed">明黄</option><option style="background-color: #333333" value="#333333">黑色</option></select><br>字体颜色<br><select name=txtcolor id=txtcolor onchange="javascript:document.getElementById(\'container\').style.color=this.options[this.selectedIndex].value;"> <option value="#000000">黑色</option><option value="#ff0000" style="color:red;">红色</option><option value="#006600" style="color:green;">绿色</option><option value="#0000ff" style="color:blue;">蓝色</option><option value="#660000" style="color:#006600;">棕色</option><option value="#ffffff">白色</option></select><br>字体大小<br><select name=fontsize id=fonttype onchange="javascript:document.getElementById(\'container\').style.fontSize=this.options[this.selectedIndex].value;"> <option value="12px" >小号</option> <option value="14px" >较小</option> <option value="19px" >中号</option> <option value="19px" >默认</option><option value="22px" >较大</option><option value="25px" >大号</option><option value="35px" >35px</option><option value="45px" >45px</option><option value="55px" >55px</option><option value="65px" >65px</option><option value="75px" >75px</option><option value="85px" >85px</option><option value="95px" >95px</option></select>><br>字体类型<br><select name=fonttype id=fonttype onchange="javascript:document.getElementById(\'container\').style.fontFamily=this.options[this.selectedIndex].value;"> <option value="宋体" >宋体</option> <option value="MV boli" style="font-family:MV boli">MV boli</option> <option value="隶书" style="font-family:隶书">隶书</option> <option value="黑体" style="font-family:黑体">黑体</option><option value="楷体" style="font-family:楷体">楷体</option><option value="幼圆" style="font-family:幼圆">幼圆</option><option value="华文中宋" style="font-family:华文中宋">华文中宋</option><option value="华文行楷" style="font-family:华文行楷">华文行楷</option><option value="微软雅黑" style="font-family:微软雅黑">微软雅黑</option><option value="Arial" style="font-family:Arial">Arial</option><option value="Vrinda" style="font-family:Vrinda">Vrinda</option><option value="Tahoma" style="font-family:Tahoma">Tahoma</option><option value="Courier" style="font-family:Courier">Courier</option><option value="Times" style="font-family:Times">Times</option><option value="Georgia" style="font-family:Georgia">Georgia</option><option value="Lucida" style="font-family:Lucida">Lucida</option></select><br><a onClick="changePage()" target="_self" id="changepage">黑底白字</a></div>');   
</script>
<style type="text/css">
#tbrowser a:linked container a:visited{
	font-size:18px;
	text-decoration:none;
}
a:link{
	text-decoration:none;
	}
#container{
	font-size:1.2em;
	margin:auto;
	font-family:"宋体";
	width:65.29%;
	line-height:1.6em;
}
P{
	margin-top:16px;
	margin-bottom:16px;
	text-indent:2em;
}
.uls{
	color:#CC6666;
	font-weight:bold;
}
.uls>ol{
	list-style:none;
	font-weight:normal;
	list-style:lower-latin;
	color:#000000;
	line-height:1.3em;
}
h3{
	font-size:1.1em;
	font-weight:bold;
	text-indent:0em;
	color:#990000;
}
h4{
	font-size:1.0em;
	font-weight:bold;
	text-indent:0em;
}

#goTopBtn, #goBottom, #shangy, #xiay, #ftsize1, #ftsize2, #ftsize3{
	width: 18px;
    line-height: 1.2;
    padding: 5px 0;
    font-size: 12px;
    text-align: center;
    position: fixed;
	right: 10px;
    cursor: pointer;
    filter: Alpha(opacity=30);
	opacity=.3;
	font-weight:bold;
}
#goTopBtn, #goBottom, #ftsize1, #ftsize3  {
    background-color:#999;
    color:#000;
}
#shangy, #xiay, #ftsize2{
    background-color: #bbb;
    color: #000;
}
#ftsize1{
	bottom:240px;
}
#ftsize2{
	bottom:214px;
}
#ftsize3{
	bottom:188px;
}

#goTopBtn{
    bottom: 105px;
}
#goBottom {
    bottom: 30px;
}
#shangy {
    bottom: 80px;
}
#xiay {
    bottom: 55px;
}
#goTopBtn:hover, #goBottom:hover, #shangy:hover, #xiay:hover, #ftsize1:hover, #ftsize2:hover, #ftsize3:hover{
	background-color:#ccc;
	border:#ccc 0px solid;
}
#goTopBtn a:link, #goBottom a:link, #xiay a:link, #shangy a:link, #ftsize1 a:link, #ftsize2 a:link, #ftsize3 a:link {
	text-decoration: none;
	color:white;
}
img{
	margin-right:2em;
	text-indent:2em;
	border:0;
}
.picsay{
	color:#930;
	font-size:90%;
	line-height:110%;
	margin-top:-12px;
	padding:0;
}
.remark{
	color:#930;
	font-size:90%;
	line-height:140%;
	margin-top:-12px;
	text-indent:0em;
	padding:0;
}
.ref{
	color:#930;
	font-size:95%;
	line-height:150%;
	margin-top:-12px;
	text-indent:2em;
	padding:0;
}
pre{
	font-size:120%;
	line-height:130%;
	padding:0;
	//background-color:#f6f6f6;
	//background-color:#fff5ee;
	//background-color:#ffe;
	background-color:#eee;
	padding:8px;
	}
.code0, .code2, .code4{
	font-size:95%;
	line-height:110%;
	margin-top:-12px;
	padding:0;
	//background-color:#D9D1CA;
	//background-color:#f6f6f6;
	//background-color:#fff5ee;
	background-color:#ffe;
}
.code0{
	color:red;
	text-indent:0em;
}
.code2{
	color:#930;
	text-indent:2em;
}
.code4{
	color:blue;
	text-indent:4em;
}
sub,sup{
	font-size:80%;
	color:red;
}
</style>
</head>

<body>

<div id="container">





<h3>经典DLL解读</h3>

<p>2017年12月14日
</p>

<p>在Windows世界中，有无数块活动的大陆，它们都有一个共同的名字——动态链接库。现在就走进这些神奇的活动大陆，找出它们隐藏已久的秘密吧！
</p>

<p>初窥门径：Windows的基石
</p>

<p>随便打开一个系统目录，一眼望去就能看到很多扩展名DLL的文件，这些就是经常说的“动态链接库”，DLL是Dynamic Link Library(即“动态链接库”)的缩写。从Microsoft公司推出首个版本的Windows以来，动态链接库就一直是这个操作系统的基础。
</p>

<p>1.看看DLL里有什么
</p>

<p>与其用晦涩的专业术语来解决DLL是什么，不如先来看看DLL里有什么。DLL和EXE文件一样，其中包含的也是程序的二进制执行代码和程序所需的资源(比如图标、对话框、字符串等)，可是为什么要把代码放在DLL里面，而不是做成EXE呢？其实DLL中的代码是以API函数形式出现的，通俗地说，DLL中包含的程序代码都被做成了一个个小模块，应用程序通过按下所需DLL中特定的按钮，来调用DLL中这个按钮所代表的功能。在使用“记事本”等程序时，如果要保存文件或打开文件，就会弹出通用文件对话框，选择文件位置。你可知道，这就是调用了系统底层DLL中的通用对话框界面。
</p>

<p>2.系统中几个重要的DLL
</p>

<p>Windows中有3个非常重要的底层DLL:Kernel32.dll、User32.dll、GDI32.dll。其中Kernel32.dll顾名思义就是内核相关的功能，主要包含用于管理内存、进程和线程的函数;而User32.dll中包含的则是用于执行用户界面任务的函数，比如把用户的鼠标点击操作传递给窗口，以便窗口根据用户的点击来执行预定的事件;GDI32.dll的名称用了缩写，全称是Graphical Device Interface(图形设备接口)，包含用于画图和显示文本的函数，比如要显示一个程序窗口，就调用了其中的函数来画这个窗口。
</p>

<p>3.为什么要用DLL
</p>

<p>刚才在谈到这个问题的时候，只解释了DLL将程序代码封装成函数的原理。为什么封装成函数，就能成为系统中大量使用DLL的理由呢？
</p>

<p>①扩展应用程序
</p>

<p>由于DLL能被应用程序动态载入内存。所以，应用程序可以在需要时才将DLL载入到内存中，这让程序的可维护性变得很高。比如QQ的视频功能需要升级，那么负责编写QQ的程序员不必将QQ所有代码都重写，只需将视频功能相关的DLL文件重写即可。
</p>

<p>②便于程序员合作
</p>

<p>这个和最终用户关系不大，仅供了解。大家都知道编程工具有很多，比如VB、VC、Delphi等，如果好几个人合作来编写一个大的程序，那么可能有的人用VB，有的人用VC，每人负责的部分所使用的编程语言都不同，究竟放在哪个编译器中进行编译呢？这就好比一群来自各个国家的人在共同编写一篇文章，如果他们所使用的语言都不同，写出来的文章怎么可能凑到一起呢？而有了DLL后，可以让VC程序员写一个DLL，然后VB程序员在程序中调用，无需为怎么将它们都编译为一个单独的EXE而发愁了。
</p>

<p>③节省内存
</p>

<p>如果多个应用程序调用的是同一个动态链接库，那么这个DLL文件不会被重复多次装入内存中，而是由这些应用程序共享同一个已载入内存的DLL。就好比一个办公室中，很少会为每一个员工配置一台饮水机的，而是在一个公共位置放上一个饮水机，所有需要喝水的职员都可以共用这台饮水机，降低了成本又节约了空间。
</p>

<p>④共享程序资源
</p>

<p>包括刚才提到过的通用文件对话框在内，DLL文件提供了应用程序间共享资源的可能。资源可以是程序对话框、字符串、图标，或者声音文件等。
</p>

<p>⑤解决应用程序本地化问题
</p>

<p>在下载了某个程序的汉化包后，打开汉化说明，经常可以看到用下载包中的DLL文件覆盖掉程序原来的DLL，汉化就完成了。这些程序都是将执行代码和应用程序界面分开编写了，所以汉化者只需简单地将其中和程序界面相关的DLL汉化并发布即可。
</p>

<p>求知若渴:探究DLL的真相
</p>

<p>谁知道DLL里究竟有多少函数，又有谁知道EXE调用了哪个DLL的哪些函数？其实，这个问题并不难解决。分析EXE文件的工具Dependency Walker(以下简称Depends，点击下载Dependency Walker)，今天它就是大家探险的工具，把DLL真相探个通通透透。
</p>

<p>1.看看DLL里有多少函数
</p>

<p>第一步:下载并解压Depends，运行其中的depends.exe，然后选择菜单“File→Open”(文件→打开)，在文件选择框中选中需要分析的DLL文件并打开，此处选择QQ目录下的QQZip.dll。
</p>

<p>第二步:在程序左侧的树状栏中就列出了这个DLL使用了哪些其他DLL的功能函数(原来DLL中还可以调用其他DLL^O^)，而右侧的两个分栏列表分别显示了函数输入及输出表，函数输出表即为该DLL提供给其他EXE或者DLL调用的函数的总列表。
</p>

<p>第三步:函数输出表的Function栏中即为输出函数的名称（见图1），在QQZip.dll中共发现了2个函数:Unzip、Zip。因此可以判断该DLL在QQ程序中负责压缩和解压缩的任务。
</p>

<p>2.审审EXE究竟用了哪个DLL
</p>

<p>还是拿QQ来作为例子，在Depends中打开QQ.exe，这时界面左侧的树状列表中显示的就是QQ.exe调用的DLL列表（见图2），如果展开这些DLL分支，还会发现其他的DLL，这就说明QQ调用的这些DLL文件还有可能(几乎是肯定)再调用别的DLL。这就好比买了一台新的DVD机，可能其中用的机芯是SONY的，而这个机芯里的一个小电容又有可能是别的公司的，这是同样的道理。
</p>

<p>3.用DLL看穿EXE真面目
</p>

<p>刚才得到了QQ.exe所使用的DLL列表，其实通过这个列表，还能分析出很多别的信息。比如其中包含MFC42.dll，所以可以判断QQ.exe是采用VC(即Visual C++)编写的，而包含WSOCK32.dll则说明这个程序带有网络通讯功能(废话！QQ如果不能网络通讯还有什么用……)。以下是一个简表，大家在分析别的EXE时可以根据其所使用的DLL来对其功能进行初步判断。
</p>

<p>DLL文件名可以判断出的EXE信息
</p>

<p>MFC42.dll 使用VC5.0/6.0编写。
</p>

<p>VBRun*.dll “*”代表数字版本号，使用VB3.0/4.0编写。
</p>

<p>MSVBVM50.dll 使用VB5.0编写，在Windows 98(SE)上自带该DLL。
</p>

<p>MSVBVM60.dll 使用VB6.0编写，在Windows Me/2000/XP等系统上自带该DLL。
</p>

<p>ADVAPI32.dll 可能会进行注册表操作。
</p>

<p>WSOCK32.dll 具备网络通讯功能。
</p>

<p>WS2_32.dll 具备网络通讯功能。
</p>

<p>WININET.dll 具备HTTP浏览、下载等功能，典型的例子是浏览器、下载工具。
</p>

<p>WINMM.dll 具备多媒体播放能力。
</p>

<p>DDRAW.dll 游戏、高级图像处理工具。
</p>

<p>D3D*.dll 3D游戏，或者动画处理工具。
</p>

<p>4.DLL是个大宝库
</p>

<p>除供应用程序调用函数的DLL外，还有另一种用来保存资源的DLL，比如QQ目录下的QQRes.dll，用Depends打开后发现没有任何输出函数，难道是一个鸡肋DLL？可是改用资源工具Resource Hacker(下载地址:http://www.onlinedown.net/soft/12420.htm)打开这个DLL后，就发现原来其中保存了这么多QQ的资源，包括图标、音乐、图片、字符串、对话框……
</p>

<p>刨根问底:DLL的寓言
</p>

<p>DLL引起的故障是很常见的，为什么会引起故障？遇到故障怎么解决？嘘～偷听一下DLL的对话，你就会明白了。
</p>

<p>1.从搬运工谈接口兼容性
</p>

<p>在Windows工地上，有一个名叫EXE的包工头，他手下有很多称为DLL的建筑工人。其中有一个专门负责搬运的DLL(暂且称为“搬运工A”)，每次需要搬运水泥时，包工头EXE都只要对他喊一声:“来！搬。”
</p>

<p>过了一段时间，搬运工A觉得自己的效率太低，于是从原来的每次搬1袋水泥改成了每次搬3袋水泥。改进了搬运方法后，EXE包工头仍然每次只是喊一声:“来！搬。”却不知搬运工A已经改变了搬运的方法。
</p>

<p>但又过了一段时间，包工头EXE把搬运工A给辞退了，从别的工地上找来了另一个DLL(暂且称为“搬运工B”)。这个搬运工在别的工地的时候，搬运东西特别快，所以包工头EXE决定把搬运工作给“升级”一下。但真正开始工作时，包工头才发现出了问题……现在不管叫几遍“来！搬。”这个新来的搬运工B都不知道究竟应该搬什么。
</p>

<p>上面的例子中，搬运工A改进搬运方法，但EXE调用它的方法仍不变，这就是DLL升级的原理，改进了内部的实现方法，但调用接口不变，这样EXE文件不用跟着升级，就能调用新版本的DLL了。而搬运工B的故事说明，不管新版本的DLL效率多高，如果接口(可以理解为DLL中输出的函数名)与原来的不一致，那么EXE就不知道也无法调用它了。
</p>

<p>2.登记身份证的DLL
</p>

<p>在系统故障中，有很多都是由于DLL文件没有注册造成的，比如Windows XP的压缩文件夹功能出现故障就很有可能是系统目录中的zipfldr.dll没有注册造成的，这类故障的解决方法也大多是运行如下命令:
</p>

<p>regsvr32 DLL文件名
</p>

<p>很多人不理解为什么要这么做，是不是所有的DLL都能这样做呢？
</p>

<p>其实系统中有两种DLL，一种是不需注册即可使用的，另一种则是必须经过系统登录(即注册)才能使用的。就好像一个临时工，和一个记录在员工名单上的长期合同工的区别一样。如何才能区分这两种DLL呢？方法很简单，用刚才的Depends打开这个DLL，同样是看函数输出表，如果其中包含以下两个函数(前者是注册DLL，后者是反注册DLL)，那么就一定是需要注册才能使用的DLL了。
</p>

<p>DllRegisterServer
</p>

<p>DllUnregisterServer
</p>

<p>而regsvr32这个命令，实际上就是调用DLL中的这两个函数(“regsvr32 /u DLL文件名”调用的即为DllUnregisterServer反注册函数)。
</p>

<p>3.插件DLL的秘密
</p>

<p>Winamp、Foobar 2000等很多软件都具有插件功能，从网上下载一个DLL放在插件目录下就能让程序支持新的功能，这是怎么做到的呢？就拿时下流行的播放软件“千千静听”来举例吧。
</p>

<p>“千千静听”的插件目录在该软件安装目录下的Addin子目录下，程序的插件目录一般都会以“Plugins”、“Addin”来命名。在“千千静听”的插件目录中有许多DLL文件，比如tt_asf.dll、tt_rm.dll等，从文件名中就能看出这些DLL是用来让这个播放器支持各种不同类型的音频文件的。同样，用Depends打开这些文件，你就会发现这些文件的输出函数表中都包括一个同样的函数:ttpGetSoundAddIn．
</p>

<p>这就是插件的秘密，各种支持插件功能的程序在发布时，都会同时发布一份插件协议，协议中规定了该程序将要调用的插件DLL中必须包含的函数名称及相关的参数规则，然后第三方的插件程序员在编写这个程序的插件时就根据这个插件的标准来编写DLL的输出函数。
</p>

<p>①对于插件tt_asf.dll
</p>

<p>ttplayer.exe(“千千静听”主程序)对tt_asf.dll说:“我要调用你的ttpGetSoundAddIn函数！”
</p>

<p>tt_asf.dll回答:“OK。”
</p>

<p>②如果把不相关的DLL放进AddIn目录
</p>

<p>ttplayer.exe对未知DLL说:“我要调用你的ttpGetSoundAddIn函数！”
</p>

<p>tt_asf.dll回答:“那是什么函数？从来没听说过！
</p>



<p style='float:right;'>本页共70段，4763个字符，11549 Byte(字节)</p>﻿




</div>


<div>
<a id="ftsizea" onclick='document.getElementById("container").style.fontSize = "1.4em";' target="_self" style="color:#fff;" title="大：1.4em"><div id="ftsize1" style="color:#fff;">大</div></a>
<a id="ftsizea" onclick='document.getElementById("container").style.fontSize = "1.2em";' target="_self" style="color:#fff;" title="中：1.2em"><div id="ftsize2" style="color:#fff;">中</div></a>
<a id="ftsizea" onclick='document.getElementById("container").style.fontSize = "1.0em";' target="_self" style="color:#fff;" title="小：1em"><div id="ftsize3" style="color:#fff;">小</div></a>

<a target="_self" style="color:#fff;"><div style="display:none; color:#fff;" id="goTopBtn">&and;</div></a>
<a onclick="shangy()" target="_self" style="color:#fff;"><div style="display:none; color:#fff;" id="shangy">&uarr;</div></a>
<a onclick="xiay()" target="_self" style="color:#fff;"><div id="xiay" style="color:#fff;">&darr;</div></a>
<a onclick="downn()" target="_self" style="color:#fff;"><div id="goBottom" style="color:#fff;">&or;</div></a>
<script type=text/javascript>
	goTopEx();
	function xiay(){
		window.scrollBy(0,window.innerHeight-10);
	}
	function shangy(){
		window.scrollBy(0,-window.innerHeight+10);
	}
	var obj3=document.getElementById("xiay");
	var obj4=document.getElementById("goBottom");
	function getHeight(){  
		if(browser4=="ch"){
			//谷歌浏览器
			return document.body.clientHeight; 
		}else{
			//IE、firefox等浏览器 
			return document.documentElement.clientHeight;  
		}  
	}
	getHeight()<window.innerHeight+50?obj3.style.display="none":obj3.style.display="";
	getHeight()<window.innerHeight+50?obj4.style.display="none":obj4.style.display="";
	if(browser4!="ch"){	//firefox需要尝一下才显示向下图标
		xiay();
		shangy();
	}
</script>
</div>

</body>
</html>
